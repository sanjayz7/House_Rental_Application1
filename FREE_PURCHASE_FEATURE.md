# Free House Purchase Feature

## Overview
This feature allows regular users to "purchase" houses from house owners completely free of cost. It's designed to simulate a property acquisition system where users can claim properties without any payment.

## Database Schema

### Purchases Table
```sql
CREATE TABLE purchases (
  purchase_id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  listing_id NUMBER NOT NULL,
  buyer_id NUMBER NOT NULL,
  seller_id NUMBER NOT NULL,
  purchase_date TIMESTAMP DEFAULT SYSTIMESTAMP,
  status VARCHAR2(20) DEFAULT 'completed' CHECK (status IN ('pending', 'completed', 'cancelled')),
  notes CLOB,
  CONSTRAINT fk_purchases_listing FOREIGN KEY (listing_id) REFERENCES listings(listing_id),
  CONSTRAINT fk_purchases_buyer FOREIGN KEY (buyer_id) REFERENCES users(user_id),
  CONSTRAINT fk_purchases_seller FOREIGN KEY (seller_id) REFERENCES users(user_id)
);
```

### Indexes
```sql
CREATE INDEX idx_purchases_buyer ON purchases(buyer_id);
CREATE INDEX idx_purchases_seller ON purchases(seller_id);
CREATE INDEX idx_purchases_listing ON purchases(listing_id);
```

### Stored Procedures
- `add_purchase()` - Creates a new purchase record
- `get_user_purchases()` - Retrieves all purchases for a specific user
- `get_seller_sales()` - Retrieves all sales for a specific seller

## API Endpoints

### Purchase Controller (`/api/purchases`)

#### POST `/`
- **Purpose**: Create a new free purchase
- **Authentication**: Required (User role)
- **Body**: 
  ```json
  {
    "listingId": 123,
    "notes": "Optional purchase notes"
  }
  ```
- **Response**: Purchase confirmation with details

#### GET `/my-purchases`
- **Purpose**: Get current user's purchase history
- **Authentication**: Required (User role)
- **Response**: Array of purchase records with property and seller details

#### GET `/my-sales`
- **Purpose**: Get current user's sales history (for house owners)
- **Authentication**: Required (Owner role)
- **Response**: Array of sales records with property and buyer details

#### GET `/stats`
- **Purpose**: Get purchase/sales statistics
- **Authentication**: Required
- **Response**: Statistics based on user role

## Frontend Implementation

### User Dashboard Enhancements
- **Purchase Statistics Card**: Shows total properties purchased
- **Purchase History Table**: Displays all user's purchases with:
  - Purchase ID
  - Property details (title, address, specs)
  - Seller information
  - Purchase date
  - Status
  - View property action

### Property Cards Enhancement
- **"Buy for FREE" Button**: Appears for users on available properties
- **Availability Check**: Only shows for properties with available units > 0
- **Purchase Confirmation**: Shows success/error alerts
- **Real-time Updates**: Refreshes property availability after purchase

### House Owner Dashboard Enhancements
- **Sales Statistics Card**: Shows total properties sold
- **Sales History Table**: Displays all sales with:
  - Sale ID
  - Property details
  - Buyer information
  - Sale date
  - Status
  - View property action

## Key Features

### 1. Free Purchase System
- Users can purchase any available property for free
- No payment processing required
- Instant purchase confirmation
- Automatic availability updates

### 2. Purchase Validation
- Only regular users can purchase properties
- Users cannot purchase their own properties
- Properties must have available units > 0
- Prevents duplicate purchases

### 3. Real-time Updates
- Property availability decreases after purchase
- Dashboards refresh automatically
- Success/error notifications
- Purchase history updates immediately

### 4. Comprehensive Tracking
- Complete purchase history for users
- Sales tracking for house owners
- Statistics and analytics
- Audit trail with timestamps

## User Experience

### For Regular Users
1. Browse available properties
2. Click "üè† Buy for FREE" button on desired property
3. Receive instant confirmation
4. View purchase in dashboard history
5. Access purchased property details

### For House Owners
1. List properties for free purchase
2. Monitor sales in dashboard
3. View buyer information
4. Track sales statistics
5. Manage property availability

## Technical Implementation

### Database Setup
1. Run `createPurchasesTable.js` to create the purchases table
2. Execute stored procedures for purchase management
3. Set up proper indexes for performance

### API Integration
1. Purchase endpoints are protected by authentication
2. Role-based access control (users can purchase, owners can view sales)
3. Error handling for edge cases
4. Automatic unit availability updates

### Frontend Integration
1. Purchase API functions in `api.js`
2. Enhanced property cards with purchase buttons
3. Updated dashboards with purchase/sales data
4. Real-time UI updates and notifications

## Security Considerations

- Authentication required for all purchase operations
- Role-based access control
- Input validation on all endpoints
- SQL injection prevention through parameterized queries
- User cannot purchase their own properties

## Future Enhancements

1. **Purchase Notifications**: Email notifications for purchases/sales
2. **Purchase Limits**: Limit number of free purchases per user
3. **Time-based Restrictions**: Purchase windows or cooldown periods
4. **Purchase Analytics**: Advanced reporting and insights
5. **Property Transfer**: Actual ownership transfer documentation
6. **Purchase Reviews**: Rating system for purchased properties

## Files Modified/Created

### Backend
- `database/schema.sql` - Added purchases table
- `server/createPurchasesTable.js` - Database setup script
- `server/controllers/purchaseController.js` - Purchase API logic
- `server/routes/purchases.js` - Purchase routes
- `server/server.js` - Added purchase routes

### Frontend
- `client/src/api.js` - Added purchase API functions
- `client/src/components/ShowList.jsx` - Added purchase buttons
- `client/src/components/UserDashboard.jsx` - Added purchase history
- `client/src/components/HouseOwnerDashboard.jsx` - Added sales tracking

## Testing

### Manual Testing Steps
1. Create user and owner accounts
2. Add properties as owner
3. Login as user and purchase properties
4. Verify purchase appears in user dashboard
5. Verify sale appears in owner dashboard
6. Check property availability updates
7. Test error cases (own property, no availability)

### Database Testing
1. Verify purchases table creation
2. Test stored procedures
3. Check data integrity
4. Validate indexes performance

This feature provides a complete free property purchase system that enhances user engagement while maintaining data integrity and providing comprehensive tracking for both users and property owners.
